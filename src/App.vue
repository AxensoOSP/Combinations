<template>
<div id="app" class="hero">
  <Keypad
    v-on:findPatient="findPatient($event)"
    v-on:clearUrl="url = ''"
  ></Keypad>
  <PatientsCombinations
    v-bind:url="this.url"
    v-bind:num="this.patients_n"
    v-bind:patients="this.patients_combinations"
    v-on:addPatientCombination="addPatientCombination($event)"
    v-on:deletePatientCombination="deletePatientCombination($event)"
  ></PatientsCombinations>
  <PatientsInformations
    v-bind:patients_urls="this.patients_urls"
    v-bind:patients_n="this.patients_n"
    v-on:updatePatientUrl="updatePatientUrl($event)"
  ></PatientsInformations>
  <CodeExport
    v-bind:patients_combinations="this.patients_combinations"
    v-bind:patients_urls="this.patients_urls"
  ></CodeExport>
</div>
</template>

<script>
import { db } from './Firebase'
import Keypad from './components/Keypad.vue'
import PatientsCombinations from './components/PatientsCombinations.vue'
import PatientsInformations from './components/PatientsInformations.vue'
import CodeExport from './components/CodeExport.vue'

const patients = db.collection("patients_urls")

export default {
  name: 'app',

  components: {
    Keypad,
    PatientsCombinations,
    PatientsInformations,
    CodeExport
  },

  computed: {

    patients_combinations () {
      var r = [];
      for (var i = 0; i < this.patients.length; i++)
        r.push(this.patients[i]['keycodes'])
      return r;
    },

    patients_urls () {
      var r = [];
      for (var i = 0; i < this.patients.length; i++)
        r.push(this.patients[i] ? this.patients[i]['url'] : "")
      return r;
    }

  },

  firestore () {
    return {
      patients: patients,
    }
  },

  data () {
    return {
      url: "",
      patients_n: 6,
    }
  },

  methods: {

    findPatient (e) {
      for (var i = 0; i < this.patients_combinations.length; i++) {
        if(this.patients_combinations[i]) {
          for (var k = 0; k < this.patients_combinations[i].length; k++) {
            if(this.patients_combinations[i][k].split(" ").sort().join(" ") == e) {
              this.url = this.patients_urls[i];
              return; // in caso di codici duplicati prende il primo
            }
          }
        }
      }
    },

    updatePatientUrl (e) {
      var i = String(e[0]);
      patients.doc(i).update({
        url: e[1]
      })
    },

    addPatientCombination (e) {
      var c = String(e[0]);

      patients.doc(c).update({
        keycodes: this.patients[c - 1]['keycodes'].concat(e[1])
      })
    },

    deletePatientCombination (e) {
      var c = String(e[0]),
          t = this.patients[c - 1]['keycodes'];

      if(t.length > 1) {
        t.splice(parseInt(e[1]), 1);
      } else {
        t = [];
      }

      patients.doc(c).update({
        keycodes: t
      })
    }

  }
}
</script>

<!-- var data = {
 "1-2-3": "03",
 "1-2-4-": "03",
 "1-2-5": "03",
 "1-2-6": "03",
 "1-2-7-": "03",
 "1-2-8": "03",
 "1-2-9": "03",
 "1-2-10": "03",
 "1-2-11": "03",
 "1-2-12": "03",
 "1-2-13": "03",
 "1-3-4": "03",
 "1-3-5": "03",
 "1-3-6": "03",
 "1-3-7": "03",
 "1-3-10": "03",
 "1-3-13": "03",
 "1-4-5": "03",
 "1-4-6": "03",
 "1-4-7": "03",
 "1-4-10": "03",
 "1-4-13": "03",
 "1-5-6": "03",
 "1-5-8": "03",
 "1-5-10": "03",
 "1-5-11": "03",
 "1-5-12": "03",
 "1-5-13": "03",
 "1-6-7": "03",
 "1-6-10": "03",
 "1-6-13": "03",
 "1-8-10": "03",
 "1-10-11": "03",
 "1-10-12": "03",
 "1-10-13": "03",
 "2-3-4": "03",
 "2-3-5": "03",
 "2-3-6": "03",
 "2-3-7": "03",
 "2-3-10": "03",
 "2-3-13": "03",
 "2-4-5": "03",
 "2-4-6": "03",
 "2-4-7": "03",
 "2-4-10": "03",
 "2-4-13": "03",
 "2-5-6": "03",
 "2-5-8": "03",
 "2-5-10": "03",
 "2-5-11": "03",
 "2-5-12": "03",
 "2-5-13": "03",
 "2-6-7": "03",
 "2-6-10": "03",
 "2-6-13": "03",
 "2-8-10": "03",
 "2-10-11": "03",
 "2-10-12": "03",
 "2-10-13": "03",
 "3-4-5": "03",
 "3-4-6": "03",
 "3-4-10": "03",
 "3-5-10": "03",
 "3-5-13": "03",
 "3-6-10": "03",
 "3-10-13": "03",
 "4-5-6": "03",
 "4-5-10": "03",
 "4-5-13": "03",
 "4-6-10": "03",
 "4-10-13": "03",
 "5-6-10": "03",
 "5-6-13": "03",
 "6-10-13": "03",
 "1-8-9": "05",
 "1-8-11": "05",
 "1-8-12": "05",
 "1-9-11": "05",
 "1-9-12": "05",
 "1-11-12": "05",
 "2-8-9": "05",
 "2-8-11": "05",
 "2-8-12": "05",
 "2-9-11": "05",
 "2-9-12": "05",
 "2-11-12": "05",
 "3-4-8": "05",
 "3-4-9": "05",
 "3-4-11": "05",
 "3-4-12": "05",
 "3-6-8": "05",
 "3-6-9": "05",
 "3-6-11": "05",
 "3-6-12": "05",
 "3-7-8": "05",
 "3-7-11": "05",
 "3-7-12": "05",
 "3-8-9": "05",
 "3-8-11": "05",
 "3-8-12": "05",
 "3-8-13": "05",
 "3-9-11": "05",
 "3-9-12": "05",
 "3-9-13": "05",
 "3-11-12": "05",
 "3-11-13": "05",
 "3-12-13": "05",
 "4-6-8": "05",
 "4-6-9": "05",
 "4-6-11": "05",
 "4-6-12": "05",
 "4-7-8": "05",
 "4-7-11": "05",
 "4-7-12": "05",
 "4-8-9": "05",
 "4-8-11": "05",
 "4-8-12": "05",
 "4-8-13": "05",
 "4-9-11": "05",
 "4-9-12": "05",
 "4-9-13": "05",
 "4-11-12": "05",
 "4-11-13": "05",
 "4-12-13": "05",
 "5-8-11": "05",
 "5-8-12": "05",
 "5-9-11": "05",
 "5-9-12": "05",
 "5-11-12": "05",
 "6-7-8": "05",
 "6-7-11": "05",
 "6-7-12": "05",
 "6-8-9": "05",
 "6-8-11": "05",
 "6-8-12": "05",
 "6-8-13": "05",
 "6-9-11": "05",
 "6-9-12": "05",
 "6-9-13": "05",
 "6-11-12": "05",
 "6-11-13": "05",
 "6-12-13": "05",
 "7-8-11": "05",
 "7-8-12": "05",
 "7-11-12": "05",
 "8-9-10": "05",
 "8-9-11": "05",
 "8-9-12": "05",
 "8-9-13": "05",
 "8-10-11": "05",
 "8-10-12": "05",
 "8-11-12": "05",
 "8-11-13": "05",
 "8-12-13": "05",
 "9-10-11": "05",
 "9-10-12": "05",
 "9-11-12": "05",
 "9-11-13": "05",
 "9-12-13": "05",
 "10-11-12": "05",
 "11-12-13": "05",
 "1-7-9": "07",
 "2-7-9": "07",
 "3-7-9": "07",
 "4-7-9": "07",
 "5-7-8": "07",
 "5-7-9": "07",
 "5-7-10": "07",
 "5-7-11": "07",
 "5-7-12": "07",
 "5-7-13": "09",
 "5-9-10": "07",
 "5-9-13": "07",
 "6-7-9": "07",
 "7-8-9": "07",
 "7-8-10": "07",
 "7-8-13": "07",
 "7-9-10": "07",
 "7-9-11": "07",
 "7-9-12": "07",
 "7-9-13": "07",
 "7-10-11": "07",
 "7-10-12": "07",
 "7-10-13": "07",
 "7-11-13": "07",
 "7-12-13": "07",
 "9-10-13": "07",
 "1-7-8": "09",
 "1-7-11": "09",
 "1-7-12": "09",
 "1-9-13": "09",
 "2-7-8": "09",
 "2-7-11": "09",
 "2-7-12": "09",
 "2-9-13": "09",
 "3-5-9": "09",
 "3-7-13": "09",
 "3-9-10": "09",
 "4-5-9": "09",
 "4-9-10": "09",
 "5-6-9": "09",
 "5-8-13": "09",
 "5-11-13": "09",
 "5-12-13": "09",
 "6-7-13": "09",
 "6-8-10": "09",
 "6-9-10": "09",
 "8-10-13": "09",
 "10-11-13": "09",
 "10-12-13": "09",
 "1-3-8": "11",
 "1-3-9": "11",
 "1-3-11": "11",
 "1-3-12": "11",
 "1-4-8": "11",
 "1-4-9": "11",
 "1-4-11": "11",
 "1-4-12": "11",
 "1-6-8": "11",
 "1-6-9": "11",
 "1-6-11": "11",
 "1-6-12": "11",
 "1-8-13": "11",
 "1-11-13": "11",
 "1-12-13": "11",
 "2-3-8": "11",
 "2-3-9": "11",
 "2-3-11": "11",
 "2-3-12": "11",
 "2-4-8": "11",
 "2-4-9": "11",
 "2-4-11": "11",
 "2-4-12": "11",
 "2-6-8": "11",
 "2-6-9": "11",
 "2-6-11": "11",
 "2-6-12": "11",
 "2-8-13": "11",
 "2-11-13": "11",
 "2-12-13": "11",
 "3-4-7": "11",
 "3-4-13": "11",
 "3-5-6": "11",
 "3-5-8": "11",
 "3-5-11": "11",
 "3-5-12": "11",
 "3-6-7": "11",
 "3-6-13": "11",
 "3-8-10": "11",
 "3-10-11": "11",
 "3-10-12": "11",
 "5-4-8": "11",
 "4-5-11": "11",
 "4-5-12": "11",
 "4-6-7": "11",
 "4-6-13": "11",
 "4-8-10": "11",
 "4-10-11": "11",
 "4-10-12": "11",
 "5-6-8": "11",
 "5-6-11": "11",
 "5-6-12": "11",
 "6-10-11": "11",
 "6-10-12": "11",
 "1-5-7": "13",
 "1-5-9": "13",
 "1-7-10": "13",
 "1-7-13": "13",
 "1-9-10": "13",
 "2-5-7": "13",
 "2-5-9": "13",
 "2-7-13": "13",
 "2-9-10": "13",
 "3-5-7": "13",
 "3-7-10": "13",
 "4-5-7": "13",
 "4-7-10": "13",
 "5-6-7": "13",
 "5-8-9": "13",
 "5-8-10": "13",
 "5-10-11": "13",
 "5-10-12": "13",
 "5-10-13": "13",
 "7-6-10": "13"
} -->
